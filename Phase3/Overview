import jwt  # Mock Okta token (pip not needed in Replit)
from sklearn.ensemble import IsolationForest  # Anomaly ML
import numpy as np

# Mock Workload (AWS/O365 sim)
class MockWorkload:
    def __init__(self):
        self.logs = []
    
    def grant(self, user):
        self.logs.append(f"Granted: {user} to AWS/O365")
        return "Access OK!"
    
    def deny(self, user, reason):
        self.logs.append(f"Denied: {user} – {reason}")
        return f"Blocked: {reason}"

# ZT Flow: Pillars + Policies
def zt_access_flow(token, user_data, persona="Alex"):  # data = [[time, geo_risk, device_score]]
    workload = MockWorkload()
    try:
        # Pillar 1: Identity (Policy 1 – Anti-Spoof)
        payload = jwt.decode(token, 'nextech_secret', algorithms=['HS256'])
        if not payload.get('mfa_passed') or payload.get('role') != 'approved':
            return workload.deny(persona, "MFA/role fail – spoof (8.1)!")
        
        # Pillar 2: Devices (Policy 2 – Posture)
        if payload.get('device_posture', 0) < 80:
            return workload.deny(persona, f"Low posture {payload['device_posture']}% – elevation risk (8.8)!")
        
        # Pillar 3: Network/Anomaly (Policy 3/5 – Tamper/DoS + AI Tweak)
        for point in user_data:
            geo_risk = point[1]
            if geo_risk > 0.5:  # High = anomaly (deepfake/geo spoof)
                return workload.deny(persona, "Anomaly: High risk – deepfake/tamper (7.5)!")
            if len(user_data) > 5 and np.mean([p[0] for p in user_data]) < 0.1:  # DoS spike
                return workload.deny(persona, "Spike detected – throttle (7.5)!")
        
        # Pillar 4: Data/Apps (Policy 4 – Disclosure)
        if payload.get('slack_share') == 'untagged':
            return workload.deny(persona, "Untagged Slack – disclosure (7.1)!")
        
        # Pillar 5: Workloads (Clear – Grant)
        return workload.grant(persona)
    
    except jwt.InvalidTokenError:
        return workload.deny(persona, "Invalid token – block!")

# Tests (Run These!)
good_payload = {'role': 'approved', 'mfa_passed': True, 'device_posture': 90, 'slack_share': 'tagged'}
good_token = jwt.encode(good_payload, 'nextech_secret', algorithm='HS256')
good_data = [[0.2, 0.1]]  # Low risk

print("=== Good Path (Alex) ===")
print(zt_access_flow(good_token, good_data, "Alex"))

bad_data = [[0.9, 0.8]]  # High geo (AI spoof tweak)
print("\n=== Bad Path (Jordan AI Spoof) ===")
print(zt_access_flow(good_token, bad_data, "Jordan"))

print("\n=== Logs ===")
print(MockWorkload().logs)  # Last instance logs
